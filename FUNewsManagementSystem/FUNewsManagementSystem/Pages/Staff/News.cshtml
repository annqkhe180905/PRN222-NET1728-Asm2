@page
@model FUNewsManagementSystem.Pages.Staff.NewsModel
@{
    ViewData["Title"] = "News Articles";
}

<div class="container mt-4 container-custom">
    @{
        var defaultImage = "/img/newsDefault.png";
        var newsArticles = Model.NewsList;
    }

    <div class="d-flex justify-content-between mb-3">
        <input type="text" id="searchInput" class="form-control w-25" placeholder="Search by title..." onkeyup="searchNews()">
        <button class="btn btn-primary" onclick="openCreateModal()">Create New</button>
    </div>

    @for (int i = 0; i < newsArticles.Count; i += 3)
    {
        <div class="row mb-4 px-2">
            @for (int j = i; j < i + 3 && j < newsArticles.Count; j++)
            {
                var news = newsArticles[j];
                <div class="col-md-4 d-flex align-items-stretch" id="newsRow_@news.NewsArticleId">
                    <div class="card card-outside-custom">
                        <div class="card card-custom h-100">
                            <img src="@(string.IsNullOrEmpty(news.ImgUrl) ? defaultImage : news.ImgUrl)" class="card-img-top" alt="News Image">
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title text-truncate" style="font-weight: bold; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                                    @news.NewsTitle
                                </h5>
                                <p class="card-text text-truncate" style="display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden;">
                                    @news.Headline
                                </p>
                                <p class="card-text text-truncate" style="display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden;">
                                    @news.NewsContent
                                </p>
                                <span class="text-muted" style="font-size: 0.9rem;">@news.CreatedDate</span>
                                <div class="mt-2 d-flex justify-content-between">
                                    <button class="btn btn-warning" onclick="openEditModal('@news.NewsArticleId')">Edit</button>
                                    <button class="btn btn-danger" onclick="openDeleteModal('@news.NewsArticleId')">Delete</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

<!-- Modal for Creating/Editing News -->
<div class="modal fade" id="newsModal" tabindex="-1" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Create News Article</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="newsForm">
                    <div class="form-group">
                        <label>Title</label>
                        <input type="text" class="form-control" id="newsTitle">
                    </div>
                    <div class="form-group">
                        <label>Headline</label>
                        <input type="text" class="form-control" id="headline">
                    </div>
                    <div class="form-group">
                        <label>Content</label>
                        <textarea class="form-control" id="newsContent"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Source</label>
                        <input type="text" class="form-control" id="newsSource">
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <select class="form-control" id="categoryId">
                            <option value="">-- Select Category --</option>
                            @foreach (var category in Model.Categories)
                            {
                                <option value="@category.CategoryId">@category.CategoryName</option>
                            }
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Tags</label>
                        <select class="form-control" id="tags" multiple>
                            @foreach (var tag in Model.Tags)
                            {
                                <option value="@tag.TagId">@tag.TagName</option>
                            }
                        </select>
                    </div>
                    <button type="submit" class="btn btn-success">Save</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    function openCreateModal() {
        $('#modalTitle').text("Create News Article");
        $('#newsForm')[0].reset();
        $('#newsModal').modal('show');
    }

    function openEditModal(id) {
        $.get("?handler=GetNews&id=" + id, function (data) {
            $('#modalTitle').text("Edit News Article");
            $('#newsTitle').val(data.newsTitle);
            $('#headline').val(data.headline);
            $('#newsContent').val(data.newsContent);
            $('#newsSource').val(data.newsSource);
            $('#categoryId').val(data.categoryId);
            $('#tags').val(data.tagIds);
            $('#newsModal').modal('show');
        });
    }

    function openDeleteModal(id) {
        if (confirm("Are you sure you want to delete this article?")) {
            deleteNews(id);
        }
    }

    function deleteNews(id) {
        $.ajax({
            type: "POST",
            url: "?handler=Delete",
            contentType: "application/json",
            data: JSON.stringify(id),
            success: function () {
                $("#newsRow_" + id).remove();
            },
            error: function () {
                alert("Error deleting news");
            }
        });
    }

    function searchNews() {
        var input = document.getElementById("searchInput").value.toLowerCase();
        $(".col-md-4").each(function () {
            var title = $(this).find(".card-title").text().toLowerCase();
            $(this).toggle(title.includes(input));
        });
    }
</script>
